<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head('Expense Form')}"></head>
<body>
<nav th:replace="~{layout :: navbar}"></nav>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
                    <h4 class="mb-0 text-gradient fw-bold" th:text="${expense.id == null ? 'New Expense' : 'Edit Expense'}">Expense Form</h4>
                </div>
                <div class="card-body p-4">
                    <form th:action="@{/expense}" th:object="${expense}" method="post" enctype="multipart/form-data">
                        <input type="hidden" th:field="*{id}">
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="category" class="form-label fw-bold">Category</label>
                                <select class="form-select" id="category" th:field="*{category}" 
                                        hx-get="/api/subcategories" 
                                        hx-target="#subCategory" 
                                        hx-trigger="change"
                                        name="category"
                                        required>
                                    <option value="">Select Category</option>
                                    <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}"></option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="subCategory" class="form-label fw-bold">SubCategory</label>
                                <select class="form-select" id="subCategory" th:field="*{subCategory}" required>
                                    <option value="">Select Category First</option>
                                    <option th:if="${subCategories != null}" 
                                            th:each="sub : ${subCategories}" 
                                            th:value="${sub.id}" 
                                            th:text="${sub.name}"></option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label fw-bold">Description</label>
                            <input type="text" class="form-control" id="description" th:field="*{description}" required>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="amount" class="form-label fw-bold">Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">â‚¹</span>
                                    <input type="number" step="0.01" class="form-control" id="amount" th:field="*{amount}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="date" class="form-label fw-bold">Date</label>
                                <input type="date" class="form-control" id="date" name="date" th:value="${#temporals.format(expense.date, 'yyyy-MM-dd')}" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="paymentMode" class="form-label fw-bold">Payment Mode</label>
                                <select class="form-select" id="paymentMode" th:field="*{paymentMode}" required>
                                    <option th:each="mode : ${paymentModes}" th:value="${mode}" th:text="${mode}"></option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="taxPercentage" class="form-label fw-bold">Tax % (Optional)</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" class="form-control" id="taxPercentage" th:field="*{taxPercentage}">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="batchId" class="form-label fw-bold">Batch ID (Optional)</label>
                            <input type="text" class="form-control" id="batchId" th:field="*{batchId}">
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Receipt Images</label>
                            <div class="d-flex gap-2 mb-2">
                                <button type="button" class="btn btn-outline-primary flex-grow-1 shadow-sm" onclick="openInput('galleryInput', 'cameraInput')">
                                    <i class="fas fa-images me-2"></i>Gallery
                                </button>
                                <button type="button" class="btn btn-outline-success flex-grow-1 shadow-sm" onclick="openInput('cameraInput', 'galleryInput')">
                                    <i class="fas fa-camera me-2"></i>Camera
                                </button>
                                <button type="button" class="btn btn-outline-secondary shadow-sm" onclick="clearFileInputs()" title="Clear Selection">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <input type="file" id="galleryInput" name="receiptFiles" accept="image/*" multiple class="d-none" onchange="handleFileSelect(this, 'cameraInput')">
                            <input type="file" id="cameraInput" name="receiptFiles" accept="image/*" capture="environment" class="d-none" onchange="handleFileSelect(this, 'galleryInput')">
                            
                            <div id="fileNameDisplay" class="form-text text-success fw-bold" style="display:none;"></div>
                            
                            <!-- Existing Files Display -->
                            <div class="mt-2">
                                <div th:each="att : ${expense.attachments}" 
                                     class="d-flex align-items-center justify-content-between border p-2 mb-2 rounded" 
                                     th:id="'attachment-' + ${att.id}">
                                    <div>
                                        <small class="text-muted d-block">Attachment</small>
                                        <a th:href="@{'/uploads/' + ${att.fileName}}" target="_blank" th:text="${att.fileName}">filename.jpg</a>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                th:hx-delete="@{'/expense/attachment/' + ${att.id}}"
                                                th:hx-confirm="'Are you sure you want to delete ' + ${att.fileName} + '?'"
                                                hx-target="closest div[id^='attachment-']"
                                                hx-swap="outerHTML"
                                                hx-on::response-error="alert('Error deleting: ' + event.detail.xhr.statusText)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div id="deletedAttachmentsContainer"></div>
                            </div>
                        </div>

                        <script>
                            function openInput(inputId, otherInputId) {
                                console.log("Opening input: " + inputId);
                                const input = document.getElementById(inputId);
                                if (input) {
                                    input.disabled = false;
                                    input.click();
                                } else {
                                    console.error("Input not found: " + inputId);
                                    alert("Error: Input element not found.");
                                }
                            }

                            function handleFileSelect(input, otherInputId) {
                                if (input.files && input.files.length > 0) {
                                    const other = document.getElementById(otherInputId);
                                    other.value = '';
                                    other.disabled = true;
                                    
                                    const display = document.getElementById('fileNameDisplay');
                                    if (input.files.length === 1) {
                                        display.textContent = 'Selected: ' + input.files[0].name;
                                    } else {
                                        display.textContent = 'Selected: ' + input.files.length + ' files';
                                    }
                                    display.style.display = 'block';
                                }
                            }



                            function clearFileInputs() {
                                document.getElementById('galleryInput').value = '';
                                document.getElementById('cameraInput').value = '';
                                document.getElementById('fileNameDisplay').style.display = 'none';
                                document.getElementById('galleryInput').disabled = false;
                                document.getElementById('cameraInput').disabled = false;
                            }

                            // Fallback for cached pages
                            function markAttachmentForDeletion(id) {
                                alert("The application has been updated. Please refresh the page to enable the new delete functionality.");
                                window.location.reload();
                            }
                        </script>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="/dashboard" class="btn btn-outline-secondary me-md-2">Cancel</a>
                            <button type="submit" class="btn btn-primary shadow-sm"><i class="fas fa-save me-2"></i>Save Draft</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:replace="~{layout :: scripts}"></script>
<script th:replace="~{layout :: htmx}"></script>
</body>
</html>
